services:
  fastapi:
    container_name: fastapi
    build:
      context: ./services/fastapi
    command: uvicorn main:app --host 0.0.0.0 --port ${PORT}

    # ğŸŒ Variables de entorno directas
    environment:
      - PORT=${PORT}
      - API_DOMAIN=${API_PROD_DOMAIN}

    # ğŸ·ï¸ Etiquetas para integraciÃ³n con Traefik
    labels:
      - traefik.enable=true

      # âš™ï¸ ConfiguraciÃ³n del Servicio FastAPI
      - "traefik.http.services.fastapi.loadbalancer.server.port=${PORT}"

      # ğŸŒ Router para FastAPI (HTTP)
      - "traefik.http.routers.fastapi-http.rule=Host(`${API_PROD_DOMAIN}`)"
      - "traefik.http.routers.fastapi-http.entrypoints=http"
      - "traefik.http.routers.fastapi-http.middlewares=redirect-to-https"

      # ğŸŒ Router para FastAPI (HTTPS)
      - "traefik.http.routers.fastapi-https.rule=Host(`${API_PROD_DOMAIN}`)"
      - "traefik.http.routers.fastapi-https.entrypoints=https"
      - "traefik.http.routers.fastapi-https.tls=true"
      - "traefik.http.routers.fastapi-https.tls.certresolver=letsencrypt"

      # ğŸ“¦ Middleware para redirecciÃ³n HTTP a HTTPS
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

    # ğŸ”„ PolÃ­tica de reinicio
    restart: unless-stopped

    # ğŸŒ Red asociada
    networks:
      - hic-cibus

# ğŸŒ Redes utilizadas
networks:
  hic-cibus:
    external: true