services:
  traefik:
    image: traefik:v3.2.3
    container_name: traefik
    restart: unless-stopped

    # ğŸ”— Puertos expuestos
    ports:
      - "80:80" # Mapea el puerto 80 del host al puerto 80 del contenedor (HTTP)
      - "443:443" # Mapea el puerto 443 del host al puerto 443 del contenedor (HTTPS)

    # ğŸ“‚ VolÃºmenes montados
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Acceso al socket de Docker
      - ./services/traefik/traefik.toml:/etc/traefik/traefik.toml # Archivo de configuraciÃ³n de Traefik
      - traefik-public-certificates:/certificates # Almacena los certificados SSL/TLS

    # ğŸ·ï¸ Etiquetas para configuraciÃ³n dinÃ¡mica
    labels:
      - "traefik.enable=true" # Habilita Traefik para este servicio
      - "traefik.docker.network=hic-cibus" # Red Docker asignada

      # ğŸŒ Router para el Dashboard de Traefik (HTTP)
      - "traefik.http.routers.dashboard-http.rule=Host(`${TRAEFIK_PROD_DOMAIN}`)" # Regla basada en el dominio
      - "traefik.http.routers.dashboard-http.entrypoints=http" # EntryPoint HTTP
      - "traefik.http.routers.dashboard-http.service=dashboard" # Servicio interno asignado al router
      - "traefik.http.routers.dashboard-http.middlewares=http-to-https" # Aplica el middleware a la regla HTTP

      # ğŸŒ Router para el Dashboard de Traefik (HTTPS)
      - "traefik.http.routers.dashboard-https.rule=Host(`${TRAEFIK_PROD_DOMAIN}`)" # Regla basada en el dominio
      - "traefik.http.routers.dashboard-https.entrypoints=https" # EntryPoint HTTPS
      - "traefik.http.routers.dashboard-https.service=dashboard" # Servicio interno asignado al router
      - "traefik.http.routers.dashboard-https.tls=true" # Habilita TLS
      - "traefik.http.routers.dashboard-https.tls.certresolver=letsencrypt" # Utiliza letsencrypt para obtener certificados SSL/TLS

      # âš™ï¸ ConfiguraciÃ³n del Servicio Dashboard
      - "traefik.http.services.dashboard.loadbalancer.server.port=8080" # Puerto interno del servicio

      # ğŸ“¦ Middleware para redirecciÃ³n HTTP a HTTPS
      - "traefik.http.middlewares.http-to-https.redirectscheme.scheme=https" # RedirecciÃ³n a HTTPS
      - "traefik.http.middlewares.http-to-https.redirectscheme.permanent=true" # RedirecciÃ³n permanente
      - "traefik.http.middlewares.http-to-https.redirectscheme.priority=1" # Prioridad de redirecciÃ³n

volumes:
  traefik-public-certificates:

networks:
  hic-cibus:
    external: true