services:
  traefik:
    image: traefik:v3.2.3
    container_name: traefik
    restart: unless-stopped

    # üîó Puertos expuestos
    ports:
      # Traefik (http)
      - "80:80"

      # Traefik (https)
      - "443:443"

      # Puertos para las Bases de Datos
      - "5432:5432" # PostgreSQL (CRUD DB)
      - "5500:5500" # PostgreSQL (EMQX DB)

      # Puertos EMQX
      - "1883:1883" # MQTT
      - "8883:8883" # MQTT seguro
      - "8083:8083" # Websocket
      - "8084:8084" # Websocket seguro


    # üìÇ Vol√∫menes montados
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro # Acceso al socket de Docker
      - ./services/traefik/traefik.toml:/etc/traefik/traefik.toml:ro # Archivo de configuraci√≥n de Traefik
      - ./services/traefik/htpasswd:/etc/traefik/htpasswd:ro # Archivo para autenticaci√≥n b√°sica
      - traefik-public-certificates:/certificates # Almacena los certificados SSL/TLS

    # üè∑Ô∏è Etiquetas para Traefik
    labels:
      - "traefik.enable=true" # Habilita Traefik para este servicio

      # Configuraci√≥n del Servicio Dashboard
      - "traefik.http.services.dashboard.loadbalancer.server.port=8080" # Puerto interno del servicio

      # Router para el Dashboard de Traefik (HTTP)
      - "traefik.http.routers.dashboard-http.rule=Host(`${TRAEFIK_DASHBOARD_DOMAIN}`)" # Regla basada en el dominio
      - "traefik.http.routers.dashboard-http.entrypoints=http" # Usa el EntryPoint HTTP
      - "traefik.http.routers.dashboard-http.middlewares=redirect-to-https" # Middleware para redirigir a HTTPS

      # Router para el Dashboard de Traefik (HTTPS)
      - "traefik.http.routers.dashboard-https.rule=Host(`${TRAEFIK_DASHBOARD_DOMAIN}`)" # Regla basada en el dominio
      - "traefik.http.routers.dashboard-https.entrypoints=https" # Usa el EntryPoint HTTPS
      - "traefik.http.routers.dashboard-https.service=api@internal" # Servicio interno para el Dashboard
      - "traefik.http.routers.dashboard-https.tls=true" # Habilita TLS
      - "traefik.http.routers.dashboard-https.tls.certresolver=letsencrypt" # Resolver de certificados SSL/TLS
      - "traefik.http.routers.dashboard-https.middlewares=auth-basic"

      # Middleware de autenticaci√≥n b√°sica
      - "traefik.http.middlewares.auth-basic.basicauth.usersfile=/etc/traefik/htpasswd"

      # Middleware para redirecci√≥n HTTP a HTTPS
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https" # Redirecci√≥n a HTTPS
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true" # Redirecci√≥n permanente

    # üåê Red asignada al servicio
    networks:
      - hic-cibus


# üìÇ Vol√∫menes
volumes:
  traefik-public-certificates:


# üåê Redes
networks:
  hic-cibus:
    external: true